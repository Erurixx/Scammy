@{
    ViewData["Title"] = "Manage User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section id="manage-user">
    <div class="container">
        <div class="dashboard-box">
            <h2 class="dashboard-title">Manage Users</h2>
            <p class="dashboard-subtitle">View, search, and manage all system users.</p>

            <!-- Top Controls -->
            <div class="top-controls">
                <!-- Tabs -->
                <ul class="nav nav-tabs custom-tabs" id="userTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="admin-tab" data-bs-toggle="tab" href="#admin" role="tab">Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="analyst-tab" data-bs-toggle="tab" href="#analyst" role="tab">Analyst</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="user-tab" data-bs-toggle="tab" href="#user" role="tab">User</a>
                    </li>
                </ul>

                <!-- Create User Button -->
                <a href="@Url.Action("CreateUser", "Admin")" class="main-button create-btn">+ Create User</a>
            </div>

            <!-- Search -->
            <div class="search-bar">
                <input type="text" class="form-control search-input" placeholder="🔍 Search by name, email..." />
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="userTabsContent">
                <!-- Admin Tab -->
                <div class="tab-pane fade show active" id="admin" role="tabpanel">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th style="width: 150px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ViewBag.Admins)
                            {
                                <tr>
                                    <td>@user.FullName</td>
                                    <td>@user.Email</td>
                                    <td>
                                        <span class="status @(user.IsActive ? "active" : "inactive")">
                                            @(user.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        @if (user.IsActive)
                                        {
                                            <button class="btn-action deactivate" onclick="toggleUser(@user.Id, false)">Deactivate</button>
                                        }
                                        else
                                        {
                                            <button class="btn-action" onclick="toggleUser(@user.Id, true)">Activate</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Analyst Tab -->
                <div class="tab-pane fade" id="analyst" role="tabpanel">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th style="width: 150px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ViewBag.Analysts)
                            {
                                <tr>
                                    <td>@user.FullName</td>
                                    <td>@user.Email</td>
                                    <td>
                                        <span class="status @(user.IsActive ? "active" : "inactive")">
                                            @(user.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        @if (user.IsActive)
                                        {
                                            <button class="btn-action deactivate" onclick="toggleUser(@user.Id, false)">Deactivate</button>
                                        }
                                        else
                                        {
                                            <button class="btn-action" onclick="toggleUser(@user.Id, true)">Activate</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- User Tab -->
                <div class="tab-pane fade" id="user" role="tabpanel">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th style="width: 150px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in ViewBag.Users)
                            {
                                <tr>
                                    <td>@user.FullName</td>
                                    <td>@user.Email</td>
                                    <td>
                                        <span class="status @(user.IsActive ? "active" : "inactive")">
                                            @(user.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        @if (user.IsActive)
                                        {
                                            <button class="btn-action deactivate" onclick="toggleUser(@user.Id, false)">Deactivate</button>
                                        }
                                        else
                                        {
                                            <button class="btn-action" onclick="toggleUser(@user.Id, true)">Activate</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div> 

        </div> 
    </div> 
</section>

@section Styles {
    <link rel="stylesheet" href="~/assets/css/ManageUser.css" />
}


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // Header scroll/reset handling
            let lastScrollTop = 0;
            let headerFixed = false;

            function resetHeader() {
                $('.header-area, .background-header').removeAttr('style');
                $('.header-area .main-nav').removeAttr('style');
                $('.header-area .main-nav .nav').removeAttr('style');
                $('.header-area .main-nav .nav li').removeAttr('style');
                $('.dropdown-menu, .submenu ul, .dropdown, .submenu').removeAttr('style');
            }

            $(window).scroll(function() {
                let scrollTop = $(this).scrollTop();
                if (scrollTop < 200 && !headerFixed) {
                    resetHeader();
                } else if (scrollTop > 200) {
                    headerFixed = false;
                }
                lastScrollTop = scrollTop;
            });

            resetHeader();
            $(document).on('click', function() {
                if (!headerFixed) setTimeout(resetHeader, 100);
            });

            setInterval(function() {
                if ($(window).scrollTop() < 200) resetHeader();
            }, 5000);

            // Tab fallback for Bootstrap JS not loaded
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener("click", function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
                    this.classList.add('active');
                    let target = document.querySelector(this.getAttribute('href'));
                    target.classList.add('show', 'active');
                });
            });

            // Toggle user active/inactive
            window.toggleUser = function(userId, activate) {
                let url = activate ? '@Url.Action("ActivateUser", "Admin")' : '@Url.Action("DeactivateUser", "Admin")';

                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: userId })
                })
                .then(response => {
                    if(response.ok){
                        location.reload();
                    } else {
                        alert("Error!");
                    }
                })
                .catch(err => console.error(err));
            };
        });
    </script>
}

